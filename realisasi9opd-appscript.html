<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard OPD — Realisasi Keuangan & Fisik</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    
    :root {
      --bg: #0740aa;
      --card: #ffffff;
      --muted: #6b7280;
      --accent-green: #07AA1F;
      --accent-blue: #1149b8;
      --accent-pink: #AA0792;
      --radius: 18px;
      --pad: 14px;
    }

    html,body{height:100%}
    body {
      margin: 0px;
      background: var(--bg);
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #0740aa;
      padding: 20px;
      box-sizing: border-box;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin: 0 auto;
      padding-bottom: 1px;
    }

    .opd-card {
      background: var(--card);
      border-radius: 20px;
      padding: var(--pad);
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      margin-bottom: 0px;
      position: relative;
      overflow: visible;
      width: calc(50% - 10px);
      box-sizing: border-box;
    }

    .emoji-wrap {
      flex: 0 0 90px;
      border-radius: 12px;
      background: linear-gradient(180deg,#fff8,#fff0);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60px;
    }

    .opd-header {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 5px;
    }

    .opd-body .total-anggaran {
      background-color: var(--accent-blue);
      color: white;
      font-weight: 700;
      font-size: 16px;
      padding: 6px 6px;
      border-radius: 8px;
      margin-top: 8px;
      text-align: center;
      width: 100%;
      max-width: 85%;
      box-sizing: border-box;
    }


    .opd-body { flex: 1; }
    .opd-title { font-weight: 800; font-size: 24px; color: #0b4aa2; margin: 0; line-height: 1; }
    .sub { color: var(--muted); margin-top: 6px; font-size: 14px; }
    .big-amount { color: var(--accent-blue); font-weight: 800; font-size: 20px; margin: 6px 0 0; }
    .small-meta { color: var(--muted); font-size: 14px; margin-top: 6px; display: flex; gap: 8px; align-items: center; }

    .toggle-btn {
      position: absolute;
      right: 12px;
      top: 12px;
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 6px;
      border-radius: 8px;
      color: var(--accent-blue);
    }

    .expandable {
      background: var(--card);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
      margin-top: 10px;
    }

    .monthly {
      background: #40AA07;
      border-radius: 16px; 
      padding: 8px; 
      text-align: center;
      margin-top: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      width: 92%; 
      margin-left: auto;
      margin-right: auto;
    }

    .monthly h3 { 
      margin: 0; 
      font-size: 12px; 
      color: #ffffff; 
    }

    .monthly .amount { 
      margin-top: 0px; 
      font-size: 22px; 
      font-weight: bold; 
      color: #ffffff; 
    }

    .chart-card {
      background: var(--card);
      border-radius: 20px;
      padding: 12px;
      margin-top: 14px;
      outline: #AA0792 solid 3px;
      width: 89%; 
      margin-left: auto;
      margin-right: auto;
      margin-bottom: 9px;
    }

    .chart-title { font-weight: bold; text-align: center; margin-bottom: 8px; font-size: 14px; }
    .legend { display: flex; gap: 12px; align-items: center; justify-content: center; margin-bottom: 10px; font-size: 13px; color: var(--muted); }
    .legend .item { display: flex; gap: 8px; align-items: center; }
    .dot { width: 18px; height: 10px; border-radius: 6px; display: inline-block; }

    .progress-row { margin-top: 8px; margin-bottom: 8px; font-size: 14px; color: #111; }
    .progress-label { margin-bottom: 6px; color: var(--muted); font-size: 13px; }
    .progress-bar { background: #e6e6e6; border-radius: 999px; height: 22px; overflow: hidden; display: flex; align-items: center; padding: 3px; }
    .progress-fill {
      height: 100%;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 800;
      min-width: 40px;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.08);
      transition: width 600ms ease;
    }

    .pie-wrapper { position: relative; padding: 10px; }
    .pie-canvas { width: 100% !important; height:auto !important; display: block; max-width: 400px; margin: 0 auto; }

      /* Membatasi ukuran pada layar yang lebih kecil */
    @media (max-width: 768px) {
      .opd-card {
        width: 100%;
      }
      .pie-canvas {
        max-width: 350px;
      }
    }

    @media (max-width: 420px) {
      .opd-card { padding: 12px; }
      .big-amount { font-size: 18px; }
      .monthly .amount { font-size: 22px; }
      .pie-canvas {
        max-width: 300px;
      }
    }

    .hingga-bg {
      background-color: #AA0792; 
      padding: 1px 4px; 
      border-radius: 5px; 
      font-weight: bold;
      color: #ffffff; 
    }

    footer {
      text-align: center;
      color: white;
      padding: 25px;
      font-size: 11px;
    }

  </style>
</head>
<body>
  <div class="container" id="containerOPD"></div>

  <script>
    
    // ⚠️ --- GANTI DENGAN URL WEB APP APPSCRIPT ANDA ---
    const APPSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyejuIHszRU2q5ozE0kGzO2FQpa-_iOoQXnAUssEwedzo85JM_zuDZ4oyDQj3rW4rqdTQ/exec'; 

    const formatRupiah = (n) => new Intl.NumberFormat('id-ID').format(n);

    // FUNGSI BARU UNTUK MENGAMBIL PARAMETER URL
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    };


    async function fetchOPDData() {
      try {
        const response = await fetch(APPSCRIPT_URL);
        return await response.json(); 
      } catch (error) {
        console.error("Gagal mengambil data dari Apps Script:", error);
        return []; 
      }
    }

    const pieLabelPlugin = {
      id: 'pieLabelPlugin',
      afterDraw(chart) {
        const { ctx } = chart;
        const meta = chart.getDatasetMeta(0);
        const data = chart.data.datasets[0].data;
        ctx.save();
        ctx.font = 'bold 11px Inter';
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        meta.data.forEach((arc, i) => {
          const pos = arc.tooltipPosition();
          ctx.fillText('Rp. ' + formatRupiah(data[i]), pos.x, pos.y);
        });
        ctx.restore();
      }
    };

    function createOPDCard(opd, idx) {
      const total = opd.realisasiTotal + opd.realisasiBulanOktober;
      const sisa = opd.totalBudget - total;
      // Perhitungan persentase keuangan menggunakan data yang diperbarui
      const persenKeuangan = (total / opd.totalBudget) * 100;

      const card = document.createElement('div');
      card.className = 'opd-card';
      card.innerHTML = `
        <div class="opd-header">
          <div class="emoji-wrap">${opd.emoji}</div>
          <div class="opd-body">
            <h1 class="opd-title">${opd.opdName}</h1>
            <div class="sub">Total Anggaran :</div>
            <div class="big-amount total-anggaran">Rp. ${formatRupiah(opd.totalBudget)}</div>
          </div>

          <button class="toggle-btn" aria-expanded="false" aria-controls="details${idx}" id="toggle${idx}">▼</button>
        </div>

        <div class="expandable" id="details${idx}" hidden>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="font-weight:700;color:#0b4aa2">Rincian OPD</div>
            <div style="color:var(--muted);font-size:13px">Status: Aktif</div>
          </div>
          <div style="margin-top:12px;color:var(--muted);font-size:14px">
            Keterangan singkat mengenai OPD dan ringkasan program.
          </div>
        </div>

        <div class="monthly">
          <h3>REALISASI BULAN OKTOBER</h3>
          <div class="amount">Rp. ${formatRupiah(opd.realisasiBulanOktober)}</div>
        </div>

        <div class="chart-card">
          <div class="chart-title">TOTAL REALISASI <span class="hingga-bg"> HINGGA</span> OKTOBER</div>

          <div class="legend">
            <div class="item"><span class="dot" style="background:var(--accent-green)"></span>Realisasi</div>
            <div class="item"><span class="dot" style="background:var(--accent-blue)"></span>Sisa Dana</div>
          </div>
          <div class="pie-wrapper"><canvas id="pie${idx}" class="pie-canvas" width="400" height="400"></canvas></div>

          <div style="margin-top:8px;">
            <div class="progress-row">
              <div class="progress-label">Realisasi Keuangan (%)</div>
              <div class="progress-bar"><div class="progress-fill" id="finance${idx}" style="width:0;background:var(--accent-green)">0%</div></div>
            </div>
            <div class="progress-row">
              <div class="progress-label">Realisasi Fisik (%)</div>
              <div class="progress-bar"><div class="progress-fill" id="physical${idx}" style="width:0;background:var(--accent-pink)">0%</div></div>
            </div>
          </div>
        </div>
      `;
      return card;
    }


    function setProgress(el, percent) {
      const val = Math.max(0, Math.min(100, percent));
      el.style.width = val + '%';
      el.textContent = val.toFixed(2).replace(/\.00$/, '') + '%';
    }

    function renderAllOPD(dataOPD) {
      const container = document.getElementById('containerOPD');
      container.innerHTML = '';
      dataOPD.forEach((opd, idx) => {
        const card = createOPDCard(opd, idx);
        container.appendChild(card);

        const total = opd.realisasiTotal + opd.realisasiBulanOktober;
        const sisa = opd.totalBudget - total;
        const persenKeuangan = (total / opd.totalBudget) * 100;

        const ctx = document.getElementById(`pie${idx}`).getContext('2d');
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels: ['Realisasi', 'Sisa Dana'],
            datasets: [{
              data: [total, sisa],
              backgroundColor: ['#07AA1F', '#0740AA'],
              borderColor: '#fff',
              borderWidth: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
              duration: 1500, 
              easing: 'easeInOutCubic',
            },
            plugins: { 
              legend: { display: false },
              tooltip: { enabled: false } 
            }
          },
          plugins: [pieLabelPlugin]
        });

        setProgress(document.getElementById(`finance${idx}`), persenKeuangan);
        setProgress(document.getElementById(`physical${idx}`), opd.percentPhysical);
      });

      attachToggles();
    }
// FUNGSI UTAMA UNTUK MENGINISIALISASI DASHBOARD
async function initDashboard() {
    // 1. Ambil parameter 'opd' dari URL (Misal: 'bmbk')
    const selectedOpdId = getUrlParameter('opd'); 
    
    // 2. Tunggu hingga semua data OPD diambil dari Google Sheet
    const allDataOPD = await fetchOPDData(); 
    
    let filteredData = [];

    // 3. Filter data menggunakan properti 'opd_id_url'
    if (selectedOpdId) {
        // ID URL sudah kecil (karena diketik manual di index.html)
        const lowerCaseSelectedId = selectedOpdId; 
        
        filteredData = allDataOPD.filter(opd => {
            // Cek apakah properti opd_id_url ada dan ubah nilainya ke huruf kecil sebelum membandingkan
            if (opd.opd_id_url) {
                return opd.opd_id_url.toLowerCase() === lowerCaseSelectedId;
            }
            return false; // Lewati jika properti tidak ada
        }); 
        
        if (filteredData.length === 0) {
            const container = document.getElementById('containerOPD');
            container.innerHTML = `<h2 style="color:white;text-align:center;">Data OPD dengan ID: "${selectedOpdId.toUpperCase()}" tidak ditemukan. <br> Mohon cek kembali ID di Google Sheet dan URL Index.</h2>`;
            document.title = `Data OPD ${selectedOpdId.toUpperCase()} Gagal</h2>`;
            return;
        }
        
        // Ganti Judul Halaman dengan nama Tampilan ('opdName')
        document.title = `Dashboard OPD — ${filteredData[0].opdName}`;
    } else {
        // Jika tidak ada parameter 'opd' di URL, tampilkan semua
        filteredData = allDataOPD; 
    }

    // 4. Tampilkan dashboard dengan data yang sudah difilter
    renderAllOPD(filteredData); 
}
    // Mulai proses inisialisasi
    initDashboard();
  </script>

<footer id="footer">
Data Extract -> https://sulselprov.e-planning.id <br> 31 Oktober 2025 | 17.05 WITA |  by @zuwlend.
</footer>

</body>
</html>


